<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Asung HMP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .chat-container {
      width: 100%;
      max-width: 480px;
      height: 80vh;
      background: #ffffff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .header {
      padding: 12px 16px;
      background: #2E7D32;
      color: #fff;
      font-weight: 600;
      font-size: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header .user-status {
      font-size: 12px;
      font-weight: 400;
      opacity: 0.8;
    }
    .messages {
      flex: 1;
      padding: 12px 16px;
      overflow-y: auto;
      overflow-anchor: none;
      font-size: 14px;
    }
    .message {
      margin-bottom: 4px;
      line-height: 1.4;
      word-break: break-word;
      max-width: 80%;
      display: flex;
      flex-direction: column;
    }
    .message .content-row {
      display: flex;
      align-items: flex-end;
      gap: 6px;
      position: relative;
    }
    .message.mine {
      margin-left: auto;
      align-items: flex-end;
    }
    .message.mine .content-row {
      flex-direction: row-reverse;
    }
    .message.mine .bubble {
      background: #4CAF50;
      color: #fff;
      border-radius: 12px 12px 0 12px;
    }
    .message.other {
      margin-right: auto;
      align-items: flex-start;
    }
    .message.other .bubble {
      background: #e9e9e9;
      color: #000;
      border-radius: 12px 12px 12px 0;
    }
    .message .bubble {
      display: inline-block;
      padding: 8px 12px;
    }
    .message .name {
      font-weight: 600;
      font-size: 14px;
      margin-top: 12px;
      margin-bottom: 6px;
      display: block;
    }
    .message .time {
      font-size: 11px;
      color: #888;
      flex-shrink: 0;
      transition: opacity 0.2s;
    }
    .message.mine .time {
      color: #aaa;
    }
    .message .content-row:hover .time,
    .message .content-row.show-reply .time {
      opacity: 0;
    }
    .message .bubble img {
      max-width: 200px;
      max-height: 200px;
      border-radius: 8px;
      cursor: pointer;
      display: block;
    }
    .message .bubble.image-bubble {
      background: transparent;
      padding: 0;
    }
    /* ì„¤ì • ëª¨ë‹¬ */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    .modal-overlay.show {
      display: flex;
    }
    .modal {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      width: 90%;
      max-width: 320px;
    }
    .modal h3 {
      margin: 0 0 16px 0;
      font-size: 16px;
    }
    .modal .field {
      margin-bottom: 12px;
    }
    .modal .field label {
      display: block;
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    .modal .field input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
    }
    .modal .buttons {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }
    .modal .buttons button {
      flex: 1;
    }
    /* ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° */
    .preview-container {
      display: none;
      padding: 8px;
      border-bottom: 1px solid #eee;
      overflow-x: auto;
      white-space: nowrap;
    }
    .preview-container.show {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .preview-item {
      position: relative;
      display: inline-block;
      flex-shrink: 0;
    }
    .preview-item img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
    }
    .preview-item .remove-btn {
      position: absolute;
      top: -6px;
      right: -6px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 10px;
      cursor: pointer;
      padding: 0;
      line-height: 18px;
    }
    .preview-count {
      font-size: 12px;
      color: #666;
      flex-shrink: 0;
    }
    .loading-more {
      text-align: center;
      padding: 8px;
      color: #888;
      font-size: 12px;
    }
    .footer {
      border-top: 1px solid #eee;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .footer-row {
      display: flex;
      gap: 6px;
    }
    input[type="text"] {
      flex: 1;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    input[type="text"].small {
      flex: 0.5;
    }
    button {
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      background: #4CAF50;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    button.secondary {
      background: #81C784;
    }
    /* ë‹µì¥ ë²„íŠ¼ */
    .reply-btn {
      background: transparent;
      color: #888;
      font-size: 16px;
      padding: 4px 8px;
      margin-left: 8px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .message:hover .reply-btn {
      opacity: 1;
    }
    /* ë‹µì¥ ëª¨ë“œ UI */
    .reply-mode {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #f0f0f0;
      border-radius: 8px;
      border-left: 3px solid #4CAF50;
    }
    .reply-button {
      position: absolute;
      right: 0;
      bottom: 0;
      background: transparent;
      color: #666;
      font-size: 16px;
      padding: 4px 8px;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
    }
    .message .content-row:hover .reply-button {
      opacity: 1;
      pointer-events: auto;
    }
    .message .content-row.show-reply .reply-button {
      opacity: 1;
      pointer-events: auto;
    }
    .message.mine .reply-button {
      right: auto;
      left: 0;
    }
    .reply-indicator {
      margin: 4px 0;
      padding: 6px 10px;
      background: #f5f5f5;
      border-left: 3px solid #4CAF50;
      border-radius: 4px;
      font-size: 12px;
      color: #666;
      cursor: pointer;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .reply-indicator:hover {
      background: #e8e8e8;
    }
    /* ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ */
    .context-menu {
      position: fixed;
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      padding: 4px 0;
      z-index: 1000;
      display: none;
    }
    .context-menu.show {
      display: block;
    }
    .context-menu-item {
      padding: 10px 20px;
      cursor: pointer;
      font-size: 14px;
      white-space: nowrap;
    }
    .context-menu-item:hover {
      background: #f0f0f0;
    }
    /* ìˆ˜ì • ëª¨ë“œ */
    .edit-mode-indicator {
      display: none;
      padding: 8px 12px;
      background: #fff3cd;
      border-left: 3px solid #ffc107;
      font-size: 12px;
      color: #856404;
      align-items: center;
      gap: 8px;
    }
    .edit-mode-indicator.show {
      display: flex;
    }
    .edited-badge {
      font-size: 10px;
      color: #999;
      margin-left: 4px;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="header">
      <span>Asung HMP</span>
      <div style="display:flex;align-items:center;gap:8px;">
        <span id="userStatus" class="user-status"></span>
        <button id="settingsBtn" style="background:transparent;padding:4px 8px;font-size:16px;">âš™ï¸</button>
      </div>
    </div>
    <div id="messages" class="messages"></div>
    <div class="footer">
      <!-- ìˆ˜ì • ëª¨ë“œ í‘œì‹œ -->
      <div id="editMode" class="edit-mode-indicator">
        <div style="flex:1;">ë©”ì‹œì§€ ìˆ˜ì • ì¤‘</div>
        <button id="cancelEditBtn" style="background:transparent;padding:4px 8px;font-size:14px;color:#856404;">ì·¨ì†Œ</button>
      </div>
      <!-- ë‹µì¥ ëª¨ë“œ í‘œì‹œ -->
      <div id="replyMode" class="reply-mode" style="display:none;">
        <div style="flex:1;min-width:0;">
          <div style="font-size:12px;color:#666;">ë‹µì¥</div>
          <div id="replyPreview" style="font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></div>
        </div>
        <button id="cancelReplyBtn" style="background:transparent;padding:4px 8px;font-size:18px;">âœ•</button>
      </div>
      <div id="previewContainer" class="preview-container">
        <span id="previewCount" class="preview-count"></span>
      </div>
      <div class="footer-row">
        <input id="messageInput" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
        <input id="imageInput" type="file" accept="image/*" multiple style="display:none;" />
        <button id="imageBtn" class="secondary">ğŸ“·</button>
        <button id="sendBtn">ì „ì†¡</button>
      </div>
    </div>

    <!-- ì„¤ì • ëª¨ë‹¬ -->
    <div id="modalOverlay" class="modal-overlay">
      <div class="modal">
        <h3>âš™ï¸ ì„¤ì •</h3>
        <div class="field">
          <label>ì•„ì´ë”” (ì„ íƒ)</label>
          <input id="userIdInput" type="text" placeholder="ì•„ì´ë”” ì…ë ¥" />
        </div>
        <div class="field">
          <label>ë‹‰ë„¤ì„</label>
          <input id="nameInput" type="text" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" />
        </div>
        <div class="buttons">
          <button id="loginBtn">ë¡œê·¸ì¸</button>
          <button id="logoutBtn" class="secondary" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
          <button id="saveNameBtn">ì €ì¥</button>
        </div>
        <div class="buttons" style="margin-top:8px;">
          <button id="notificationBtn">ğŸ”” ì•Œë¦¼ ì¼œê¸°</button>
        </div>
        <div class="buttons" style="margin-top:8px;">
          <button id="closeModalBtn" class="secondary">ë‹«ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ -->
  <div id="contextMenu" class="context-menu">
    <div class="context-menu-item" id="contextEdit">ìˆ˜ì •</div>
    <div class="context-menu-item" id="contextReply">ë‹µì¥</div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js"></script>

  <script>
    const firebaseConfig = {
        apiKey: "AIzaSyDVn1_utqTMBFOXnGNAt78i1LH8nH9AWjs",
        authDomain: "mylove-1e603.firebaseapp.com",
        databaseURL: "https://mylove-1e603-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "mylove-1e603",
        storageBucket: "mylove-1e603.firebasestorage.app",
        messagingSenderId: "28187724372",
        appId: "1:28187724372:web:8bd8796f047482c848bbc1",
        measurementId: "G-79ZYWRBD70"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();
    let messaging = null;
    try {
      messaging = firebase.messaging();
    } catch (err) {
      console.log("FCM ì´ˆê¸°í™” ì‹¤íŒ¨ (í‘¸ì‹œ ì•Œë¦¼ ë¹„í™œì„±í™”):", err);
    }
    const messagesRef = db.ref("messages");
    const usersRef = db.ref("users");
    const fcmTokensRef = db.ref("fcmTokens");

    // FCM VAPID í‚¤
    const VAPID_KEY = "BIS2lwuLLzIiAIu9bTQ38C_tdOIj_LIf1VHWsq-W7zedbb44lvM0y9bC_cF8c3Fd2709wA83nHpqZxirsPfiCzE";

    const messagesEl = document.getElementById("messages");
    const userIdInput = document.getElementById("userIdInput");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const nameInput = document.getElementById("nameInput");
    const saveNameBtn = document.getElementById("saveNameBtn");
    const messageInput = document.getElementById("messageInput");
    const imageInput = document.getElementById("imageInput");
    const imageBtn = document.getElementById("imageBtn");
    const sendBtn = document.getElementById("sendBtn");
    const userStatus = document.getElementById("userStatus");
    const settingsBtn = document.getElementById("settingsBtn");
    const modalOverlay = document.getElementById("modalOverlay");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const notificationBtn = document.getElementById("notificationBtn");
    const previewContainer = document.getElementById("previewContainer");
    const previewCount = document.getElementById("previewCount");
    const replyMode = document.getElementById("replyMode");
    const replyPreview = document.getElementById("replyPreview");
    const cancelReplyBtn = document.getElementById("cancelReplyBtn");
    const editMode = document.getElementById("editMode");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const contextMenu = document.getElementById("contextMenu");
    const contextEdit = document.getElementById("contextEdit");
    const contextReply = document.getElementById("contextReply");

    // í˜„ì¬ ë¡œê·¸ì¸ëœ ì•„ì´ë”” (ì—†ìœ¼ë©´ null)
    let currentUserId = null;
    
    // ìœ ì € ì •ë³´ ìºì‹œ (ì‹¤ì‹œê°„ ë™ê¸°í™”)
    let usersCache = {};

    // ë‹µì¥ ëª¨ë“œ ìƒíƒœ
    let replyToMessageId = null;
    let replyToMessage = null;

    // ìˆ˜ì • ëª¨ë“œ ìƒíƒœ
    let editingMessageId = null;
    let editingOriginalText = null;

    // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ëŒ€ìƒ
    let contextTargetMessageId = null;
    let contextTargetMessage = null;

    // ëŒ€ê¸° ì¤‘ì¸ ì´ë¯¸ì§€ íŒŒì¼ë“¤ (ìµœëŒ€ 10ì¥)
    let pendingImageFiles = [];

    // ì¤‘ë³µ ì „ì†¡ ë°©ì§€
    let lastSentText = "";
    let lastSentTime = 0;

    // ì´ì „ ë©”ì‹œì§€ ë¡œë“œìš©
    let oldestTimestamp = null;
    let isLoadingMore = false;
    let noMoreMessages = false;

    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì´ì „ ìƒíƒœ ë³µì›
    const savedUserId = localStorage.getItem("chat_user_id");
    const savedName = localStorage.getItem("chat_user_name");

    if (savedUserId) {
      userIdInput.value = savedUserId;
      loginWithId(savedUserId);
    } else if (savedName) {
      nameInput.value = savedName;
    }

    // ì„¤ì • ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
    settingsBtn.addEventListener("click", () => {
      modalOverlay.classList.add("show");
    });
    closeModalBtn.addEventListener("click", () => {
      modalOverlay.classList.remove("show");
    });
    modalOverlay.addEventListener("click", (e) => {
      if (e.target === modalOverlay) {
        modalOverlay.classList.remove("show");
      }
    });

    // Service Worker ë“±ë¡ ë° ì•Œë¦¼ ì„¤ì •
    let swRegistration = null;
    
    async function registerServiceWorker() {
      console.log("registerServiceWorker ì‹œì‘");
      if ('serviceWorker' in navigator) {
        try {
          swRegistration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
          console.log('Service Worker ë“±ë¡ ì„±ê³µ:', swRegistration);
        } catch (err) {
          console.error('Service Worker ë“±ë¡ ì‹¤íŒ¨:', err);
        }
      } else {
        console.log('Service Worker ì§€ì› ì•ˆ ë¨');
      }
    }
    registerServiceWorker();

    // ì•Œë¦¼ ë²„íŠ¼ í´ë¦­
    notificationBtn.addEventListener("click", async () => {
      console.log("ì•Œë¦¼ ë²„íŠ¼ í´ë¦­ë¨");
      
      if (typeof Notification === 'undefined') {
        alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì•Œë¦¼ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\niOS Safariì˜ ê²½ìš° í™ˆ í™”ë©´ì— ì¶”ê°€ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");
        return;
      }
      
      try {
        const permission = await Notification.requestPermission();
        console.log("ì•Œë¦¼ ê¶Œí•œ:", permission);
        if (permission === 'granted') {
          console.log("Service Worker ë“±ë¡ ì‹œë„...");
          await registerServiceWorker();
          console.log("swRegistration:", swRegistration);
          console.log("FCM ì„¤ì • ì‹œë„...");
          await setupFCM();
          notificationBtn.textContent = "ğŸ”” ì•Œë¦¼ ì¼œì§ (ê°±ì‹ ë¨)";
          alert("ì•Œë¦¼ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤!");
        } else {
          alert("ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
      } catch (err) {
        console.error("ì•Œë¦¼ ì„¤ì • ì˜¤ë¥˜:", err);
        alert("ì•Œë¦¼ ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
      }
    });

    // FCM í† í° ë°œê¸‰ ë° ì €ì¥
    async function setupFCM() {
      console.log("setupFCM ì‹œì‘");
      if (!messaging) {
        console.log("FCMì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤");
        return;
      }
      try {
        console.log("í† í° ë°œê¸‰ ì‹œë„...");
        const token = await messaging.getToken({
          vapidKey: VAPID_KEY,
          serviceWorkerRegistration: swRegistration
        });
        
        console.log("ë°œê¸‰ëœ í† í°:", token);
        if (token) {
          const tokenKey = token.replace(/[.#$\/\[\]]/g, '_');
          console.log("DBì— ì €ì¥ ì‹œë„...", tokenKey);
          await fcmTokensRef.child(tokenKey).set({
            token: token,
            name: nameInput.value.trim() || "ìµëª…",
            userId: currentUserId || null,
            updatedAt: Date.now()
          });
          console.log("DB ì €ì¥ ì™„ë£Œ!");
        } else {
          console.log("í† í°ì´ nullì…ë‹ˆë‹¤");
        }
      } catch (err) {
        console.error("FCM í† í° ë°œê¸‰ ì‹¤íŒ¨:", err);
      }
    }

    // í¬ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€ ìˆ˜ì‹ 
    if (messaging) {
      messaging.onMessage((payload) => {
        console.log("í¬ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€:", payload);
        // ì°½ì´ í¬ì»¤ìŠ¤ë¥¼ ìƒì—ˆì„ ë•Œë§Œ ì•Œë¦¼ í‘œì‹œ (ë‹¤ë¥¸ íƒ­, ë‹¤ë¥¸ ì•±)
        if (typeof Notification !== 'undefined' && !document.hasFocus() && Notification.permission === 'granted') {
          const title = (payload.notification && payload.notification.title) || 'ìƒˆ ë©”ì‹œì§€';
          const body = (payload.notification && payload.notification.body) || '';
          new Notification(title, {
            body: body,
            icon: '/icon.png'
          });
        }
      });
    }

    // ì•Œë¦¼ ìƒíƒœ ì´ˆê¸°í™”
    if (typeof Notification !== 'undefined' && Notification.permission === 'granted') {
      notificationBtn.textContent = "ğŸ”” ì•Œë¦¼ ì¼œì§";
      registerServiceWorker().then(() => setupFCM());
    }

    // í´ë¦½ë³´ë“œ ë¶™ì—¬ë„£ê¸° (Ctrl+V / Cmd+V)
    document.addEventListener("paste", (e) => {
      const items = e.clipboardData && e.clipboardData.items;
      if (!items) return;

      const imageFiles = [];
      for (const item of items) {
        if (item.type.startsWith("image/")) {
          const file = item.getAsFile();
          if (file) imageFiles.push(file);
        }
      }

      if (imageFiles.length > 0) {
        e.preventDefault();
        addImageFiles(imageFiles);
      }
    });

    // ì´ë¯¸ì§€ íŒŒì¼ë“¤ ì¶”ê°€
    function addImageFiles(files) {
      for (const file of files) {
        if (pendingImageFiles.length >= 10) {
          alert("ì´ë¯¸ì§€ëŠ” ìµœëŒ€ 10ì¥ê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
          break;
        }
        if (file.size > 5 * 1024 * 1024) {
          alert(`${file.name || 'ì´ë¯¸ì§€'}: 5MB ì´í•˜ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
          continue;
        }
        pendingImageFiles.push(file);
      }
      renderPreviews();
    }

    // ë¯¸ë¦¬ë³´ê¸° ë Œë”ë§
    function renderPreviews() {
      // ê¸°ì¡´ ë¯¸ë¦¬ë³´ê¸° ì•„ì´í…œë“¤ ì œê±° (ì¹´ìš´íŠ¸ ì œì™¸)
      const existingItems = previewContainer.querySelectorAll(".preview-item");
      existingItems.forEach(item => item.remove());

      if (pendingImageFiles.length === 0) {
        previewContainer.classList.remove("show");
        previewCount.textContent = "";
        return;
      }

      previewContainer.classList.add("show");
      previewCount.textContent = `${pendingImageFiles.length}/10`;

      pendingImageFiles.forEach((file, index) => {
        const item = document.createElement("div");
        item.className = "preview-item";

        const img = document.createElement("img");
        const reader = new FileReader();
        reader.onload = (e) => { img.src = e.target.result; };
        reader.readAsDataURL(file);

        const removeBtn = document.createElement("button");
        removeBtn.className = "remove-btn";
        removeBtn.textContent = "âœ•";
        removeBtn.onclick = () => removeImageAt(index);

        item.appendChild(img);
        item.appendChild(removeBtn);
        previewContainer.insertBefore(item, previewCount);
      });
    }

    // íŠ¹ì • ì¸ë±ìŠ¤ì˜ ì´ë¯¸ì§€ ì œê±°
    function removeImageAt(index) {
      pendingImageFiles.splice(index, 1);
      renderPreviews();
    }

    // ë‹µì¥ ëª¨ë“œ í™œì„±í™”
    function enterReplyMode(messageId, messageData) {
      exitEditMode(); // ìˆ˜ì • ëª¨ë“œ í•´ì œ
      replyToMessageId = messageId;
      replyToMessage = messageData;
      
      const previewText = messageData.text || (messageData.imageUrl ? "ì‚¬ì§„" : "");
      const displayName = messageData.userId && usersCache[messageData.userId] 
        ? usersCache[messageData.userId].name || messageData.userId
        : messageData.name || "ìµëª…";
      
      replyPreview.textContent = `${displayName}: ${previewText}`;
      replyMode.style.display = "flex";
      messageInput.focus();
    }

    // ë‹µì¥ ëª¨ë“œ í•´ì œ
    function exitReplyMode() {
      replyToMessageId = null;
      replyToMessage = null;
      replyMode.style.display = "none";
    }

    // ìˆ˜ì • ëª¨ë“œ í™œì„±í™”
    function enterEditMode(messageId, messageText) {
      exitReplyMode(); // ë‹µì¥ ëª¨ë“œ í•´ì œ
      editingMessageId = messageId;
      editingOriginalText = messageText;
      messageInput.value = messageText;
      editMode.classList.add("show");
      sendBtn.textContent = "ìˆ˜ì •";
      messageInput.focus();
    }

    // ìˆ˜ì • ëª¨ë“œ í•´ì œ
    function exitEditMode() {
      editingMessageId = null;
      editingOriginalText = null;
      messageInput.value = "";
      editMode.classList.remove("show");
      sendBtn.textContent = "ì „ì†¡";
    }

    // ë‹µì¥ ì·¨ì†Œ ë²„íŠ¼
    cancelReplyBtn.addEventListener("click", exitReplyMode);

    // ìˆ˜ì • ì·¨ì†Œ ë²„íŠ¼
    cancelEditBtn.addEventListener("click", exitEditMode);

    // ë¡œê·¸ì¸ ë²„íŠ¼
    loginBtn.addEventListener("click", () => {
      const userId = userIdInput.value.trim();
      if (!userId) {
        alert("ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }
      loginWithId(userId);
    });

    // ì•„ì´ë””ë¡œ ë¡œê·¸ì¸
    function loginWithId(userId) {
      usersRef.child(userId).once("value").then((snapshot) => {
        if (snapshot.exists()) {
          // ê¸°ì¡´ ì‚¬ìš©ì
          const userData = snapshot.val();
          nameInput.value = userData.name || "";
          currentUserId = userId;
          localStorage.setItem("chat_user_id", userId);
          localStorage.setItem("chat_user_name", userData.name || "");
          updateUIForLogin(true);
        } else {
          // ì‹ ê·œ ì‚¬ìš©ì - ë¹ˆ ì´ë¦„ìœ¼ë¡œ ìƒì„±
          usersRef.child(userId).set({ name: "" }).then(() => {
            currentUserId = userId;
            nameInput.value = "";
            localStorage.setItem("chat_user_id", userId);
            updateUIForLogin(true);
            alert("ìƒˆ ì•„ì´ë””ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹‰ë„¤ì„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.");
          });
        }
        refreshMessages();
      }).catch((err) => {
        console.error(err);
        alert("ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      });
    }

    // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
    logoutBtn.addEventListener("click", () => {
      currentUserId = null;
      localStorage.removeItem("chat_user_id");
      userIdInput.value = "";
      updateUIForLogin(false);
      refreshMessages();
    });

    // ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¥¸ UI ì—…ë°ì´íŠ¸
    function updateUIForLogin(isLoggedIn) {
      if (isLoggedIn) {
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        userIdInput.disabled = true;
        userStatus.textContent = `@${currentUserId}`;
      } else {
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        userIdInput.disabled = false;
        userStatus.textContent = "";
      }
    }

    // ë‹‰ë„¤ì„ ì €ì¥
    saveNameBtn.addEventListener("click", () => {
      const name = nameInput.value.trim();
      if (!name) {
        alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      if (currentUserId) {
        // ë¡œê·¸ì¸ ìƒíƒœë©´ Firebaseì—ë„ ì €ì¥
        usersRef.child(currentUserId).update({ name: name }).then(() => {
          localStorage.setItem("chat_user_name", name);
          alert("ë‹‰ë„¤ì„ ì €ì¥ ì™„ë£Œ");
        }).catch((err) => {
          console.error(err);
          alert("ë‹‰ë„¤ì„ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
      } else {
        // ë¹„ë¡œê·¸ì¸ ìƒíƒœë©´ ë¡œì»¬ì—ë§Œ ì €ì¥
        localStorage.setItem("chat_user_name", name);
        alert("ë‹‰ë„¤ì„ ì €ì¥ ì™„ë£Œ");
      }
    });

    // ë©”ì‹œì§€ ì „ì†¡
    async function sendMessage() {
      const name = nameInput.value.trim();
      if (!name) {
        alert("ë¨¼ì € ì„¤ì •ì—ì„œ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ê³  ì €ì¥í•˜ì„¸ìš”.");
        modalOverlay.classList.add("show");
        return;
      }

      const text = messageInput.value.trim();
      
      // ìˆ˜ì • ëª¨ë“œì¸ ê²½ìš°
      if (editingMessageId) {
        if (!text) {
          alert("ë©”ì‹œì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
          return;
        }
        
        sendBtn.disabled = true;
        sendBtn.textContent = "â³";
        
        try {
          await messagesRef.child(editingMessageId).update({
            text: text,
            edited: true,
            editedAt: Date.now()
          });
          exitEditMode();
        } catch (err) {
          console.error(err);
          alert("ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
          sendBtn.disabled = false;
          sendBtn.textContent = "ìˆ˜ì •";
        }
        return;
      }

      // ì¼ë°˜ ì „ì†¡ ëª¨ë“œ
      const hasImages = pendingImageFiles.length > 0;
      const hasText = text.length > 0;

      if (!hasImages && !hasText) return;

      const now = Date.now();

      // ì¤‘ë³µ ì „ì†¡ ë°©ì§€ (0.3ì´ˆ ë‚´ ê°™ì€ í…ìŠ¤íŠ¸)
      if (hasText && text === lastSentText && now - lastSentTime < 300) {
        console.log("ì¤‘ë³µ ì „ì†¡ ë°©ì§€");
        return;
      }

      sendBtn.disabled = true;
      sendBtn.textContent = "â³";

      try {
        // 1. ì´ë¯¸ì§€ë“¤ ë¨¼ì € ì „ì†¡
        for (const file of pendingImageFiles) {
          await sendImageFile(file);
        }

        // 2. í…ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ê·¸ ë‹¤ìŒì— ì „ì†¡
        if (hasText) {
          lastSentText = text;
          lastSentTime = Date.now();

          const messageData = {
            text: text,
            timestamp: Date.now()
          };

          if (currentUserId) {
            messageData.userId = currentUserId;
          } else {
            messageData.name = name;
          }

          // ë‹µì¥ ì •ë³´ ì¶”ê°€
          if (replyToMessageId) {
            messageData.replyTo = {
              messageId: replyToMessageId,
              text: replyToMessage.text || (replyToMessage.imageUrl ? "ì‚¬ì§„" : ""),
              name: replyToMessage.userId && usersCache[replyToMessage.userId]
                ? usersCache[replyToMessage.userId].name || replyToMessage.userId
                : replyToMessage.name || "ìµëª…"
            };
          }

          await messagesRef.push(messageData);
          
          // ë‹µì¥ ëª¨ë“œ í•´ì œ
          exitReplyMode();
        }

        // ì´ˆê¸°í™”
        pendingImageFiles = [];
        renderPreviews();
        messageInput.value = "";

      } catch (err) {
        console.error(err);
        alert("ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = "ì „ì†¡";
      }
    }

    // ì´ë¯¸ì§€ íŒŒì¼ ì „ì†¡ í•¨ìˆ˜
    async function sendImageFile(file) {
      const name = nameInput.value.trim();

      const fileName = `${Date.now()}_${file.name || 'image.png'}`;
      const storageRef = storage.ref(`images/${fileName}`);
      const metadata = { contentType: file.type };
      await storageRef.put(file, metadata);
      const imageUrl = await storageRef.getDownloadURL();

      const messageData = {
        imageUrl: imageUrl,
        timestamp: Date.now()
      };

      if (currentUserId) {
        messageData.userId = currentUserId;
      } else {
        messageData.name = name;
      }

      await messagesRef.push(messageData);
    }

    sendBtn.addEventListener("click", sendMessage);
    messageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    // ì´ë¯¸ì§€ ë²„íŠ¼ í´ë¦­ ì‹œ íŒŒì¼ ì„ íƒ ì°½ ì—´ê¸°
    imageBtn.addEventListener("click", () => {
      imageInput.click();
    });

    // ì´ë¯¸ì§€ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸°ì— ì¶”ê°€
    imageInput.addEventListener("change", (e) => {
      const files = Array.from(e.target.files);
      if (files.length > 0) {
        addImageFiles(files);
      }
      imageInput.value = "";
    });

    // ë©”ì‹œì§€ ìƒˆë¡œê³ ì¹¨ (ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ì‹œ)
    function refreshMessages() {
      messagesEl.innerHTML = "";
      oldestTimestamp = null;
      noMoreMessages = false;
      messagesRef.limitToLast(100).once("value").then((snapshot) => {
        snapshot.forEach((child) => {
          addMessage(child.val(), child.key);
        });
      });
    }

    // ì‹¤ì‹œê°„ ë©”ì‹œì§€ ìˆ˜ì‹ 
    messagesRef.limitToLast(100).on("child_added", (snapshot) => {
      addMessage(snapshot.val(), snapshot.key);
    });

    // ì‹¤ì‹œê°„ ë©”ì‹œì§€ ìˆ˜ì •
    messagesRef.on("child_changed", (snapshot) => {
      const msgId = snapshot.key;
      const msgData = snapshot.val();
      const msgEl = document.querySelector(`[data-msg-id="${msgId}"]`);
      
      if (msgEl && msgData.text) {
        const bubbleEl = msgEl.querySelector('.bubble:not(.image-bubble)');
        const timeEl = msgEl.querySelector('.time');
        if (bubbleEl) {
          bubbleEl.textContent = msgData.text;
        }
        if (timeEl && msgData.edited) {
          const timeText = msgData.timestamp ? formatTime(msgData.timestamp) : "";
          timeEl.innerHTML = `${timeText}<span class="edited-badge">(ìˆ˜ì •ë¨)</span>`;
        }
      }
    });

    // ìŠ¤í¬ë¡¤ ë§¨ ìœ„ ê°ì§€ â†’ ì´ì „ ë©”ì‹œì§€ ë¡œë“œ
    messagesEl.addEventListener("scroll", () => {
      if (messagesEl.scrollTop < 50 && !isLoadingMore && !noMoreMessages && oldestTimestamp) {
        loadOlderMessages();
      }
    });

    // ëª¨ë°”ì¼: ë§í’ì„  íƒ­í•˜ë©´ ë‹µì¥ ë²„íŠ¼ í† ê¸€
    messagesEl.addEventListener("click", (e) => {
      const contentRow = e.target.closest(".content-row");
      if (contentRow && 
          !e.target.closest(".reply-button") && 
          !e.target.closest(".reply-indicator") &&
          !e.target.closest(".time") &&
          !e.target.closest("img")) {
        // ë‹¤ë¥¸ ëª¨ë“  content-rowì˜ show-reply ì œê±°
        messagesEl.querySelectorAll(".content-row.show-reply").forEach(el => {
          if (el !== contentRow) el.classList.remove("show-reply");
        });
        // í˜„ì¬ content-row í† ê¸€
        contentRow.classList.toggle("show-reply");
      }
    });

    // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ (ìš°í´ë¦­)
    messagesEl.addEventListener("contextmenu", (e) => {
      const messageEl = e.target.closest(".message");
      if (!messageEl) return;
      
      e.preventDefault();
      
      const msgId = messageEl.dataset.msgId;
      if (!msgId) return;
      
      messagesRef.child(msgId).once("value").then((snapshot) => {
        if (!snapshot.exists()) return;
        
        const msg = snapshot.val();
        contextTargetMessageId = msgId;
        contextTargetMessage = msg;
        
        // ë‚´ ë©”ì‹œì§€ì¸ì§€ í™•ì¸
        const isMine = (currentUserId && msg.userId === currentUserId) || 
                       (!currentUserId && !msg.userId && msg.name === nameInput.value.trim());
        
        // í…ìŠ¤íŠ¸ ë©”ì‹œì§€ë§Œ ìˆ˜ì • ê°€ëŠ¥
        const canEdit = isMine && msg.text && !msg.imageUrl;
        
        // ë©”ë‰´ í•­ëª© í‘œì‹œ/ìˆ¨ê¹€
        contextEdit.style.display = canEdit ? "block" : "none";
        contextReply.style.display = "block";
        
        // ë©”ë‰´ ìœ„ì¹˜
        contextMenu.style.left = e.pageX + "px";
        contextMenu.style.top = e.pageY + "px";
        contextMenu.classList.add("show");
      });
    });

    // ê¸¸ê²Œ ëˆ„ë¥´ê¸° (ëª¨ë°”ì¼)
    let longPressTimer = null;
    messagesEl.addEventListener("touchstart", (e) => {
      const messageEl = e.target.closest(".message");
      if (!messageEl) return;
      
      longPressTimer = setTimeout(() => {
        const msgId = messageEl.dataset.msgId;
        if (!msgId) return;
        
        messagesRef.child(msgId).once("value").then((snapshot) => {
          if (!snapshot.exists()) return;
          
          const msg = snapshot.val();
          contextTargetMessageId = msgId;
          contextTargetMessage = msg;
          
          const isMine = (currentUserId && msg.userId === currentUserId) || 
                         (!currentUserId && !msg.userId && msg.name === nameInput.value.trim());
          
          const canEdit = isMine && msg.text && !msg.imageUrl;
          
          contextEdit.style.display = canEdit ? "block" : "none";
          contextReply.style.display = "block";
          
          const touch = e.touches[0];
          contextMenu.style.left = touch.pageX + "px";
          contextMenu.style.top = touch.pageY + "px";
          contextMenu.classList.add("show");
        });
      }, 500);
    });

    messagesEl.addEventListener("touchend", () => {
      if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
      }
    });

    messagesEl.addEventListener("touchmove", () => {
      if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
      }
    });

    // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ë‹«ê¸°
    document.addEventListener("click", () => {
      contextMenu.classList.remove("show");
    });

    // ìˆ˜ì • ë©”ë‰´ í´ë¦­
    contextEdit.addEventListener("click", (e) => {
      e.stopPropagation();
      enterEditMode(contextTargetMessageId, contextTargetMessage.text);
      contextMenu.classList.remove("show");
    });

    // ë‹µì¥ ë©”ë‰´ í´ë¦­
    contextReply.addEventListener("click", (e) => {
      e.stopPropagation();
      enterReplyMode(contextTargetMessageId, contextTargetMessage);
      contextMenu.classList.remove("show");
    });

    // ì´ì „ ë©”ì‹œì§€ 50ê°œ ë¡œë“œ
    async function loadOlderMessages() {
      isLoadingMore = true;
      
      // í˜„ì¬ ì²« ë²ˆì§¸ ë©”ì‹œì§€ ê¸°ì–µ
      const firstMessage = messagesEl.querySelector(".message");
      
      // ë¡œë”© í‘œì‹œ ì¶”ê°€
      const loadingEl = document.createElement("div");
      loadingEl.className = "loading-more";
      loadingEl.textContent = "ì´ì „ ë©”ì‹œì§€ ë¡œë“œ ì¤‘...";
      messagesEl.insertBefore(loadingEl, messagesEl.firstChild);

      try {
        const snapshot = await messagesRef
          .orderByChild("timestamp")
          .endBefore(oldestTimestamp)
          .limitToLast(50)
          .once("value");

        const messages = [];
        snapshot.forEach((child) => {
          messages.push({ key: child.key, val: child.val() });
        });

        // ë¡œë”© í‘œì‹œ ì œê±°
        loadingEl.remove();

        if (messages.length === 0) {
          noMoreMessages = true;
        } else {
          // ê°€ì¥ ì˜¤ë˜ëœ timestampë¡œ ì—…ë°ì´íŠ¸
          const minTimestamp = Math.min(...messages.map(m => m.val.timestamp));
          oldestTimestamp = minTimestamp;

          // ìµœì‹ ìˆœ ì •ë ¬ í›„ ë§¨ ì•ì— ì¶”ê°€ (ê²°ê³¼ì ìœ¼ë¡œ ì˜¤ë˜ëœ ê²Œ ìœ„ë¡œ)
          messages.sort((a, b) => b.val.timestamp - a.val.timestamp);
          
          for (const msg of messages) {
            prependMessage(msg.val, msg.key);
          }

          // ê¸°ì¡´ ì²« ë²ˆì§¸ ë©”ì‹œì§€ ìœ„ì¹˜ë¡œ ìŠ¤í¬ë¡¤ ë³µì›
          if (firstMessage) {
            requestAnimationFrame(() => {
              messagesEl.scrollTop = firstMessage.offsetTop;
            });
          }
        }
      } catch (err) {
        console.error("ì´ì „ ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨:", err);
        loadingEl.remove();
      } finally {
        isLoadingMore = false;
      }
    }

    // ë©”ì‹œì§€ë¥¼ ë§¨ ì•ì— ì¶”ê°€
    function prependMessage(msg, msgId) {
      let isMine = false;
      if (currentUserId && msg.userId) {
        isMine = msg.userId === currentUserId;
      } else if (!currentUserId && !msg.userId) {
        isMine = msg.name === nameInput.value.trim();
      }

      let displayName;
      if (msg.userId && usersCache[msg.userId]) {
        displayName = usersCache[msg.userId].name || msg.userId;
      } else if (msg.userId) {
        displayName = msg.userId;
      } else {
        displayName = msg.name || "ìµëª…";
      }

      let contentHtml;
      if (msg.imageUrl) {
        contentHtml = `<span class="bubble image-bubble"><img src="${escapeHtml(msg.imageUrl)}" onclick="window.open('${escapeHtml(msg.imageUrl)}', '_blank')" alt="ì´ë¯¸ì§€" /></span>`;
      } else {
        contentHtml = `<span class="bubble">${escapeHtml(msg.text || "")}</span>`;
      }

      const div = document.createElement("div");
      div.className = `message ${isMine ? "mine" : "other"}`;
      if (msgId) div.dataset.msgId = msgId;
      if (msg.userId) div.dataset.userId = msg.userId;
      
      // ë‹¤ìŒ ë©”ì‹œì§€(ì•„ë˜ìª½)ë¶€í„° ê°™ì€ ì‚¬ëŒì¸ì§€ í™•ì¸í•´ì„œ ì—°ì† ìˆ˜ ì¹´ìš´íŠ¸
      let consecutiveAfter = 0;
      const allMessages = messagesEl.querySelectorAll(".message");
      for (let i = 0; i < allMessages.length; i++) {
        const nextMsg = allMessages[i];
        const nextUserId = nextMsg.dataset.userId;
        const nextNameEl = nextMsg.querySelector(".name");
        const nextName = nextNameEl ? nextNameEl.textContent : null;
        
        // ìˆ¨ê²¨ì§„ ë‹‰ë„¤ì„ì¸ ê²½ìš° data-sender í™•ì¸ í•„ìš”
        const nextSender = nextMsg.dataset.sender || nextName;
        
        const isSameSender = (msg.userId && msg.userId === nextUserId) || 
                             (!msg.userId && !nextUserId && displayName === nextSender);
        
        if (isSameSender) {
          consecutiveAfter++;
        } else {
          break;
        }
      }

      // ì´ ë©”ì‹œì§€ê°€ ì—°ì†ì˜ ì‹œì‘ì´ë©´ ë‹‰ë„¤ì„ í‘œì‹œ
      // ë‹¨, ì•„ë˜ë¡œ ì—°ì† 10ê°œ ì´ìƒ ìˆìœ¼ë©´ ë‹‰ë„¤ì„ ìˆ¨ê¹€ (10ë²ˆì§¸ë§ˆë‹¤ í‘œì‹œë˜ë„ë¡)
      const showName = consecutiveAfter % 10 === 0;

      // ë‹µì¥ í‘œì‹œ HTML
      let replyHtml = "";
      if (msg.replyTo) {
        replyHtml = `<div class="reply-indicator" onclick="scrollToMessage('${msg.replyTo.messageId}')">â†© ${escapeHtml(msg.replyTo.name)}: ${escapeHtml(msg.replyTo.text.substring(0, 50))}${msg.replyTo.text.length > 50 ? '...' : ''}</div>`;
      }

      div.innerHTML = `
        ${showName ? `<span class="name">${escapeHtml(displayName)}</span>` : ""}
        ${replyHtml}
        <div class="content-row">
          ${contentHtml}
          <span class="time">${msg.timestamp ? formatTime(msg.timestamp) : ""}${msg.edited ? '<span class="edited-badge">(ìˆ˜ì •ë¨)</span>' : ''}</span>
          <button class="reply-button" onclick="replyToMsg('${msgId}')">â†©</button>
        </div>
      `;
      
      // sender ì •ë³´ ì €ì¥ (ë‹‰ë„¤ì„ì´ ìˆ¨ê²¨ì§„ ê²½ìš°ì—ë„ ë¹„êµ ê°€ëŠ¥í•˜ë„ë¡)
      div.dataset.sender = displayName;

      // ë‹¤ìŒ ë©”ì‹œì§€(ì•„ë˜ìª½)ì™€ ê°™ì€ ì‚¬ëŒ/ê°™ì€ ì‹œê°„ì´ë©´ í˜„ì¬ íƒ€ì„ìŠ¤íƒ¬í”„ ìˆ¨ê¹€
      const nextMessage = messagesEl.querySelector(".message");
      if (nextMessage) {
        const nextUserId = nextMessage.dataset.userId;
        const nextSender = nextMessage.dataset.sender;
        const nextTimeEl = nextMessage.querySelector(".time");
        const nextTime = nextTimeEl ? nextTimeEl.textContent : "";
        const currentTime = msg.timestamp ? formatTime(msg.timestamp) : "";
        
        const isSameSender = (msg.userId && msg.userId === nextUserId) || 
                             (!msg.userId && !nextUserId && displayName === nextSender);
        
        if (isSameSender && nextTime === currentTime) {
          div.querySelector(".time").style.visibility = "hidden";
        }
      }
      
      messagesEl.insertBefore(div, messagesEl.firstChild);

      // ê°€ì¥ ì˜¤ë˜ëœ timestamp ì—…ë°ì´íŠ¸
      if (!oldestTimestamp || msg.timestamp < oldestTimestamp) {
        oldestTimestamp = msg.timestamp;
      }
    }

    // users ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ - ì´ë¦„ ë³€ê²½ ì‹œ í™”ë©´ ì—…ë°ì´íŠ¸
    usersRef.on("value", (snapshot) => {
      usersCache = snapshot.val() || {};
      updateDisplayedNames();
    });

    // í™”ë©´ì— í‘œì‹œëœ ì´ë¦„ë“¤ ì—…ë°ì´íŠ¸
    function updateDisplayedNames() {
      const messages = messagesEl.querySelectorAll(".message[data-user-id]");
      messages.forEach((msgEl) => {
        const userId = msgEl.dataset.userId;
        if (usersCache[userId]) {
          const nameEl = msgEl.querySelector(".name");
          if (nameEl) {
            nameEl.textContent = usersCache[userId].name || userId;
          }
        }
      });
    }

    function formatTime(ts) {
      const d = new Date(ts);
      return `${String(d.getHours()).padStart(2, "0")}:${String(d.getMinutes()).padStart(2, "0")}`;
    }

    function addMessage(msg, msgId) {
      // ë‚´ ë©”ì‹œì§€ íŒë³„
      let isMine = false;
      if (currentUserId && msg.userId) {
        isMine = msg.userId === currentUserId;
      } else if (!currentUserId && !msg.userId) {
        isMine = msg.name === nameInput.value.trim();
      }

      // ì´ë¦„ ê²°ì •: userIdê°€ ìˆìœ¼ë©´ ìºì‹œì—ì„œ ì¡°íšŒ, ì—†ìœ¼ë©´ ì €ì¥ëœ name ì‚¬ìš©
      let displayName;
      if (msg.userId && usersCache[msg.userId]) {
        displayName = usersCache[msg.userId].name || msg.userId;
      } else if (msg.userId) {
        displayName = msg.userId; // ìºì‹œì— ì—†ìœ¼ë©´ ì¼ë‹¨ userId í‘œì‹œ
      } else {
        displayName = msg.name || "ìµëª…";
      }

      // ë©”ì‹œì§€ ë‚´ìš© (í…ìŠ¤íŠ¸ ë˜ëŠ” ì´ë¯¸ì§€)
      let contentHtml;
      if (msg.imageUrl) {
        contentHtml = `<span class="bubble image-bubble"><img src="${escapeHtml(msg.imageUrl)}" onclick="window.open('${escapeHtml(msg.imageUrl)}', '_blank')" alt="ì´ë¯¸ì§€" onload="var m=document.getElementById('messages');if(m)m.scrollTop=m.scrollHeight;" /></span>`;
      } else {
        contentHtml = `<span class="bubble">${escapeHtml(msg.text || "")}</span>`;
      }

      const div = document.createElement("div");
      div.className = `message ${isMine ? "mine" : "other"}`;
      if (msgId) div.dataset.msgId = msgId;
      if (msg.userId) div.dataset.userId = msg.userId;
      
      // ê°™ì€ ì‚¬ëŒì˜ ì—°ì† ë©”ì‹œì§€ ìˆ˜ ì¹´ìš´íŠ¸ (ì´ì „ ë©”ì‹œì§€ë“¤ í™•ì¸)
      let consecutiveCount = 0;
      const allMessages = messagesEl.querySelectorAll(".message");
      for (let i = allMessages.length - 1; i >= 0; i--) {
        const prevMsg = allMessages[i];
        const prevUserId = prevMsg.dataset.userId;
        const prevSender = prevMsg.dataset.sender;
        
        const isSameSender = (msg.userId && msg.userId === prevUserId) || 
                             (!msg.userId && !prevUserId && displayName === prevSender);
        
        if (isSameSender) {
          consecutiveCount++;
        } else {
          break;
        }
      }

      // ì—°ì† 10ê°œ ì´í•˜ë©´ ë‹‰ë„¤ì„ ìˆ¨ê¹€ (10, 20, 30ë²ˆì§¸ì— ë‹¤ì‹œ í‘œì‹œ)
      const showName = consecutiveCount % 10 === 0;

      // ë‹µì¥ í‘œì‹œ HTML
      let replyHtml = "";
      if (msg.replyTo) {
        replyHtml = `<div class="reply-indicator" onclick="scrollToMessage('${msg.replyTo.messageId}')">â†© ${escapeHtml(msg.replyTo.name)}: ${escapeHtml(msg.replyTo.text.substring(0, 50))}${msg.replyTo.text.length > 50 ? '...' : ''}</div>`;
      }

      div.innerHTML = `
        ${showName ? `<span class="name">${escapeHtml(displayName)}</span>` : ""}
        ${replyHtml}
        <div class="content-row">
          ${contentHtml}
          <span class="time">${msg.timestamp ? formatTime(msg.timestamp) : ""}${msg.edited ? '<span class="edited-badge">(ìˆ˜ì •ë¨)</span>' : ''}</span>
          <button class="reply-button" onclick="replyToMsg('${msgId}')">â†©</button>
        </div>
      `;

      // sender ì •ë³´ ì €ì¥ (ë‹‰ë„¤ì„ì´ ìˆ¨ê²¨ì§„ ê²½ìš°ì—ë„ ë¹„êµ ê°€ëŠ¥í•˜ë„ë¡)
      div.dataset.sender = displayName;

      // ì´ì „ ë©”ì‹œì§€ì™€ ê°™ì€ ì‚¬ëŒ/ê°™ì€ ì‹œê°„ì´ë©´ ì´ì „ íƒ€ì„ìŠ¤íƒ¬í”„ ìˆ¨ê¹€
      const prevMessage = messagesEl.lastElementChild;
      if (prevMessage && prevMessage.classList.contains("message")) {
        const prevUserId = prevMessage.dataset.userId;
        const prevSender = prevMessage.dataset.sender;
        const prevTimeEl = prevMessage.querySelector(".time");
        const prevTime = prevTimeEl ? prevTimeEl.textContent : "";
        const currentTime = msg.timestamp ? formatTime(msg.timestamp) : "";
        
        const isSameSender = (msg.userId && msg.userId === prevUserId) || 
                             (!msg.userId && !prevUserId && displayName === prevSender);
        
        if (isSameSender && prevTime === currentTime) {
          if (prevTimeEl) prevTimeEl.style.visibility = "hidden";
        }
      }
      
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      // ê°€ì¥ ì˜¤ë˜ëœ timestamp ì¶”ì 
      if (msg.timestamp && (!oldestTimestamp || msg.timestamp < oldestTimestamp)) {
        oldestTimestamp = msg.timestamp;
      }
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // ë‹µì¥ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬ (ì „ì—­)
    window.replyToMsg = function(messageId) {
      messagesRef.child(messageId).once("value").then((snapshot) => {
        if (snapshot.exists()) {
          enterReplyMode(messageId, snapshot.val());
        }
      });
    };

    // ì›ë³¸ ë©”ì‹œì§€ë¡œ ìŠ¤í¬ë¡¤ (ì—°ë‘ìƒ‰ í•˜ì´ë¼ì´íŠ¸)
    window.scrollToMessage = function(messageId) {
      const targetEl = document.querySelector(`[data-msg-id="${messageId}"]`);
      if (targetEl) {
        targetEl.scrollIntoView({ behavior: "smooth", block: "center" });
        targetEl.style.transition = "background-color 0.6s ease";
        targetEl.style.backgroundColor = "#c8e6c9";
        setTimeout(() => {
          targetEl.style.backgroundColor = "";
        }, 1500);
      } else {
        alert("ì›ë³¸ ë©”ì‹œì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      }
    };

    // ì´ˆê¸° UI ìƒíƒœ
    if (savedUserId) {
      updateUIForLogin(true);
    }
  </script>
</body>
</html>